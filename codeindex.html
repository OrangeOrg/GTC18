<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
		<title>创建三维场景</title>
		<link href="./js/Cesium/Widgets/widgets.css" rel="stylesheet">
		<link href="./css/pretty.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="css/index.css" />
		<script src="./js/jquery.min.js"></script>
		<script type="text/javascript" src="./js/require.min.js" data-main="js/main"></script>
		<script src="data/addairport.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/index.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/core.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/CreatlinePoints.js" type="text/javascript" charset="utf-8"></script>
		<style>
			html,
			body,
			#cesiumContainer {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
				overflow: hidden;
				background-color: #000000;
			}
			
			.l-popup .l-popup-table {
				border: 2px solid #4d9ff4;
			}
		</style>
	</head>

	<body>
		<div id="cesiumContainer"></div>
		<div id='loadingbar' class="spinner">
			<div class="spinner-container container1">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="spinner-container container2">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="spinner-container container3">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
		</div>
		<script>
			var viewer;
			var scene;
			var CountryStates = [];
			var modelurl = ['./data/PM.s3m']
			var DynamicLayer3Dlayer;
			var leftClick_handler;
			var sceneBubble;

			function onload(Cesium) {
				viewer = new Cesium.Viewer('cesiumContainer', {
					//使用本地的一张图片初始化地球，建议图片长宽比2:1
					imageryProvider: new Cesium.SingleTileImageryProvider({
						url: ''
					}),
					infoBox: false,
					selectionIndicator: false,
					sceneMode: Cesium.SceneMode.COLUMBUS_VIEW

				});
				viewer.scene.undergroundMode = true; //设置开启地下场景
				viewer.scene.screenSpaceCameraController.minimumZoomDistance = -1000; //设置相机最小缩放距离,距离地表-1000米

				viewer.scene.terrainProvider.isCreateSkirt = false;
				var globe = viewer.scene.globe;
				globe.globeAlpha = 0.001;
				scene = viewer.scene;
				sceneBubble = new Bubble(scene);
				//DynamicLayer3Dlayer = new Cesium.DynamicLayer3D(scene._context, modelurl);
				//scene.primitives.add(DynamicLayer3Dlayer);
				//DynamicLayer3Dlayer.updateInterval = 200;

				leftClick_handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
				addleftClick_handlerAction(true);

				viewer.scene.skyBox.show = false;
				viewer.scene.sun.show = false;
				viewer.scene.bloomEffect.show = true; //启用泛光效果
				viewer.scene.bloomEffect.threshold = 0.35;
				viewer.scene.bloomEffect.bloomIntensity = 1;

				addWorlddata();
				//addPTdata();
				addRoatePOI(POIPoints);
				//addCountryState();

				//var pointsArr = CreatlinePoints(startPosition, airPoints, 200000, 100)
				//var lines = DrawLines(pointsArr)

				$('#loadingbar').remove();
			}
			var addWorlddata = function() {
				var promise = Cesium.GeoJsonDataSource.load('data/china.json');
				promise.then(function(dataSource) {
					window.chinadatasource = dataSource;
					viewer.dataSources.add(dataSource);

					//Get the array of entities
					var entities = dataSource.entities.values;

					for(var i = 0; i < entities.length; i++) {
						var entity = entities[i];
						var name = entity.name;
						entity.id = -1;
						//entity.polygon.material =Cesium.Color.CADETBLUE.withAlpha(0.8) ;
						entity.polygon.material = new Cesium.Color(30 / 255, 80 / 255, 140 / 255, 1);
//						entity.polygon.material = new Cesium.ImageMaterialProperty({
//							image: 'images/tou.png',
//							repeat: new Cesium.Cartesian2(1, 1),
//							transparent: true
//						})

						entity.polygon.outlineColor = new Cesium.Color(120 / 255, 120 / 255, 120 / 255, 0.6);
						//Remove the outlines.
						entity.polygon.outline = true;
						entity.polygon.closeBottom = true;
						entity.polygon.closeTop = true;

						entity.polygon.extrudedHeight = 150000;
					}
					//viewer.flyTo(entities);
				}).otherwise(function(error) {
					//Display any errrors encountered while loading.
					window.alert(error);
				});
			}
			var addPTdata = function() {
				var promise = Cesium.GeoJsonDataSource.load('data/平台分区.json');
				promise.then(function(dataSource) {
					window.chinadatasource = dataSource;
					viewer.dataSources.add(dataSource);

					//Get the array of entities
					var entities = dataSource.entities.values;

					for(var i = 0; i < entities.length; i++) {
						var entity = entities[i];
						var name = entity.name;
						entity.id = -1;
						//entity.polygon.material =Cesium.Color.CADETBLUE.withAlpha(0.8) ;
						entity.polygon.material = new Cesium.Color(99 / 255,96 / 255, 100/ 255, 1);

						entity.polygon.outlineColor = new Cesium.Color(120 / 255, 120 / 255, 120 / 255, 1);
						//Remove the outlines.
						entity.polygon.outline = true;
						entity.polygon.closeBottom = false;
						entity.polygon.closeTop = true;

						entity.polygon.extrudedHeight = 150000;
					}
					//viewer.flyTo(entities);
				}).otherwise(function(error) {
					//Display any errrors encountered while loading.
					window.alert(error);
				});
			}

			//点击动态对象查询弹出气泡
			var addleftClick_handlerAction = function(value) {
				//clearAll();

				var inputfn = leftClick_handler.getInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
				if(inputfn !== undefined) {
					leftClick_handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
				}
				if(value === true) {

					leftClick_handler.setInputAction(function(e) {
						var selectedState = viewer.selectedEntity;
						if(selectedState !== undefined) {
							var position = viewer.selectedEntity.position;
							if(position !== undefined) {
								var info = selectedState._description;
								sceneBubble.showAt(position._value);
								sceneBubble.container.change({
									contentTable: {
										name: ['id', 'id', 'id', 'id'],
										value: [info, info, info, info]
									}
								})
							} else {
								sceneBubble.container.hide();
							}
						} else {
							sceneBubble.container.hide();
						}

					}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

				} else {
					var inputfn = leftClick_handler.getInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK)
					if(inputfn !== undefined) {
						leftClick_handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
					}
					sceneBubble.container.hide();

				}

			}

			var addRoatePOI = function(POIObjs) {
				POIObjs.forEach(function(value, index, array) {
					var POIEntity = viewer.entities.add({
						name: value[2],
						position: Cesium.Cartesian3.fromDegrees(value[0], value[1], 180000),
						ellipse: {
							semiMinorAxis: 100000,
							semiMajorAxis: 100000,
							height: 180000,
							material: new Cesium.ImageMaterialProperty({
								image: 'images/red3.png',
								repeat: new Cesium.Cartesian2(1, 1),
								transparent: true
							}),
							rotation: new Cesium.CallbackProperty(getRotationValue, false),
							stRotation: new Cesium.CallbackProperty(getRotationValue, false),
							outline: false, // height must be set for outline to display
							numberOfVerticalLines: 100
						},
						description: '测试数据'

					});

				})
				var rotation = Cesium.Math.toRadians(30);

				function getRotationValue() {
					rotation += 0.002;
					return rotation;
				}

			}
		</script>
	</body>

</html>