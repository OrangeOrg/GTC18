<!DOCTYPE html>
<html lang="en">

	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
		<title>创建三维场景</title>
		<link href="./js/Cesium/Widgets/widgets.css" rel="stylesheet">
		<link href="./css/pretty.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="css/index.css" />
		<script src="./js/jquery.min.js"></script>
		<script type="text/javascript" src="./js/require.min.js" data-main="js/main"></script>
		<script src="data/addairport.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/index.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/core.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/CreatlinePoints.js" type="text/javascript" charset="utf-8"></script>
		<style>
			html,
			body,
			#cesiumContainer {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
				overflow: hidden;
				background-color: #000000;
			}
			
			.l-popup .l-popup-table {
				border: 2px solid #4d9ff4;
			}
		</style>
	</head>

	<body>
		<div id="cesiumContainer"></div>
		<div id='loadingbar' class="spinner">
			<div class="spinner-container container1">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="spinner-container container2">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
			<div class="spinner-container container3">
				<div class="circle1"></div>
				<div class="circle2"></div>
				<div class="circle3"></div>
				<div class="circle4"></div>
			</div>
		</div>
		<script>
			var viewer;
			var scene;
			var CountryStates = [];
			var modelurl = ['./data/red5.s3m']
			var DynamicLayer3Dlayer;
			var leftClick_handler;
			var sceneBubble;

			function onload(Cesium) {
				viewer = new Cesium.Viewer('cesiumContainer', {
					//使用本地的一张图片初始化地球，建议图片长宽比2:1
					imageryProvider: new Cesium.SingleTileImageryProvider({
						url: ''
					}),
					infoBox: false,
					selectionIndicator: false
					//					sceneMode: Cesium.SceneMode.COLUMBUS_VIEW

				});
				scene = viewer.scene;
				sceneBubble = new Bubble(scene);
				DynamicLayer3Dlayer = new Cesium.DynamicLayer3D(scene._context, modelurl);
				scene.primitives.add(DynamicLayer3Dlayer);
				DynamicLayer3Dlayer.updateInterval = 200;

				leftClick_handler = new Cesium.ScreenSpaceEventHandler(scene.canvas);
				addleftClick_handlerAction(true);

				viewer.scene.skyBox.show = false;
				viewer.scene.sun.show = false;
				viewer.scene.bloomEffect.show = true; //启用泛光效果
				viewer.scene.bloomEffect.threshold = 0.6;
				viewer.scene.bloomEffect.bloomIntensity = 1;

				addWorlddata();
				//addCountryState();

				addRoatePOI(airPoints);

				var pointsArr = CreatlinePoints(startPosition, airPoints, 200000, 100)
				var lines = DrawLines(pointsArr)

				$('#loadingbar').remove();
			}
			var addWorlddata = function() {
				var promise = Cesium.GeoJsonDataSource.load('data/world.json');
				promise.then(function(dataSource) {
					viewer.dataSources.add(dataSource);

					//Get the array of entities
					var entities = dataSource.entities.values;

					for(var i = 0; i < entities.length; i++) {
						var entity = entities[i];
						var name = entity.name;
						if(Math.random() < 0.3) {
							entity.polygon.material = new Cesium.Color(23 / 255, 27 / 255, 25 / 255, 1);
						} else if(Math.random() >= 0.3 && Math.random() < 0.6) {
							entity.polygon.material = new Cesium.Color(80 / 255, 80 / 255, 80 / 255, 1);
						} else {
							entity.polygon.material = new Cesium.Color(50 / 255, 50 / 255, 50 / 255, 1);
						}

						entity.polygon.outlineColor = new Cesium.Color(100 / 255, 100 / 255, 100 / 255, 1);
						//Remove the outlines.
						entity.polygon.outline = true;
						entity.polygon.closeBottom = false;

						entity.polygon.extrudedHeight = 1000;
					}
				}).otherwise(function(error) {
					//Display any errrors encountered while loading.
					window.alert(error);
				});
			}
			var scaleValue = 0;
			var addRoatePOI = function(POIObjs) {
				POIObjs.forEach(function(value, index, array) {
					var imgurl = '';
					switch(value[3]) {
						case 1:
							imgurl = 'images/red.png'
							break;
						case 2:
							imgurl = 'images/blue.png'
							break;
						case 3:
							imgurl = 'images/green.png'
							break;
						default:
							break;
					}

					var POIEntity = viewer.entities.add({
						name: value[2],
						position: Cesium.Cartesian3.fromDegrees(value[0], value[1], 200000),
						ellipse: {
							semiMinorAxis: new Cesium.CallbackProperty(function() {
								var that=this;
								console.log(that)
								return scaleValue
							}, false),
							semiMajorAxis: new Cesium.CallbackProperty(function() {
								if(scaleValue < 300000) {
									scaleValue += 300

								} else {
									scaleValue = 0
								}
								return scaleValue
							}, false),
							height: 1200,
							material: new Cesium.ImageMaterialProperty({
								image: imgurl,
								repeat: new Cesium.Cartesian2(1, 1),
								transparent: true
							}),
							//							rotation: new Cesium.CallbackProperty(getRotationValue, false),
							//							stRotation: new Cesium.CallbackProperty(getRotationValue, false),
							outline: false, // height must be set for outline to display
							numberOfVerticalLines: 100
						},
						description: '测试数据'

					});

				})
				var rotation = Cesium.Math.toRadians(30);

				function getRotationValue() {
					rotation += 0.002;
					return rotation;
				}

			}

			//点击动态对象查询弹出气泡
			var addleftClick_handlerAction = function(value) {
				//clearAll();

				var inputfn = leftClick_handler.getInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
				if(inputfn !== undefined) {
					leftClick_handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
				}
				if(value === true) {

					leftClick_handler.setInputAction(function(e) {
						var position = scene.pickPosition(e.position);

						//将笛卡尔坐标转化为经纬度坐标
						var cartographic = Cesium.Cartographic.fromCartesian(position);
						var longitude = Cesium.Math.toDegrees(cartographic.longitude);
						var latitude = Cesium.Math.toDegrees(cartographic.latitude);
						var height = cartographic.height;

						var selectedState = viewer.selectedEntity.primitive;
						if(selectedState !== undefined) {
							var info = selectedState._description;
							sceneBubble.showAt(position);
							sceneBubble.container.change({
								contentTable: {
									name: ['id', 'id', 'id', 'id'],
									value: [info.id, info.id, info.id, info.id]
								}
							})
						} else {
							sceneBubble.container.hide();
						}

					}, Cesium.ScreenSpaceEventType.LEFT_CLICK);

				} else {
					var inputfn = leftClick_handler.getInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK)
					if(inputfn !== undefined) {
						leftClick_handler.removeInputAction(Cesium.ScreenSpaceEventType.LEFT_CLICK);
					}
					sceneBubble.container.hide();

				}

			}
		</script>
	</body>

</html>